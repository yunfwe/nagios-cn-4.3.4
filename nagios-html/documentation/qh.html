<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Nagios: Query Handler</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="qh">Query Handler </a></h1><p>A brief intro to the Nagios query handler system</p>
<p>[TOC]</p>
<h2><a class="anchor" id="purpose">
Purpose</a></h2>
<p>The purpose of the query handler is to provide Nagios Core and its eventbroker modules with the ability to communicate directly with the outside world through a well-defined API, as well as allowing external apps a way to help out with various Nagios tasks.</p>
<h2><a class="anchor" id="caveats">
Caveats</a></h2>
<p>The query handlers run in the main thread. Nagios doesn't provide any parallelism here and main Nagios will be blocked while a query is running. As such, it's a very good idea to make ones queryhandlers complete in as little time as possible.</p>
<h2><a class="anchor" id="qh_registering">
Registering a query handler</a></h2>
<p>This is really for module authors only.</p>
<p>To register a query handler, you *must* have a function like the one below: the following arguments: </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> lala_query_handler(<span class="keywordtype">int</span> sd, <span class="keywordtype">char</span> *query, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> query_len)
</pre></div><p>The parameters don't have to have those exact names, and the function certainly doesn't have to be called "lala_query_handler()". We're not quite that childish (well, we are, but we like to pretend we're not). They will suffice for this explanation, however. </p>
<ul>
<li>sd - The socket you should respond to. </li>
<li>query - The query, minus the address and the magic byte. </li>
<li>query_len - Length of the query, in bytes.</li>
</ul>
<p>The call to register it with Nagios so you get all queries directed to the 'lala' address is then: </p>
<div class="fragment"><pre class="fragment">qh_register_handler(<span class="stringliteral">&quot;lala&quot;</span>, <span class="stringliteral">&quot;The LaLa query handler&quot;</span>, 0,
lala_query_handler);
</pre></div><p>The second argument is a description, which will be printed when someone sends a help request. </p>
<dl class="note"><dt><b>Note:</b></dt><dd>It's a good idea to handle queries such as "help" and take them to mean "print me some text telling me at least the basics
of how to use this query handler".</dd></dl>
<h2><a class="anchor" id="syntax">
Syntax</a></h2>
<p>The query language is remarkably simple (although each handler may implement its own parsers that handle and do pretty much whatever they want). The first byte is magic. If it's an at-sign, we expect the queryer to persist and issue more queries after the first one. If it's a hash-sign, the query handler will disconnect the client as soon as it regains control from whatever handler registered for the particular address. Each particular handler has some control over this behaviour though, and can use specific return codes to denote that it will take over the socket from the query handler. If no at-sign and no hash-sign is present at the first byte, the -1'th byte will be considered an at-sign, and the connection will consequently be considered persistent.</p>
<h3><a class="anchor" id="qh_examples">
Example queries</a></h3>
<p>Subscribe for real-time push-events for servicechecks from the NERD radio: </p>
<div class="fragment"><pre class="fragment">
@nerd subscribe servicechecks\0
</pre></div><p>One-shot query the core query handler for current load-control options: </p>
<div class="fragment"><pre class="fragment">
#core loadctl\0
</pre></div><p>Get Nagios to say hi to you: </p>
<div class="fragment"><pre class="fragment">
#echo Greetings, Exalted One
</pre></div><p>Ask the help handler to list registered handlers: </p>
<div class="fragment"><pre class="fragment">
#help list
</pre></div><h2><a class="anchor" id="icqh">
In-core query handlers</a></h2>
<p>There are a few in-core query handlers.</p>
<h3><a class="anchor" id="help">
The help service</a></h3>
<p>The help query handler is quite possibly the most important one. It can be used to list registered handlers (with short descriptions), and can be used to get help about registered handlers (assuming they've implemented it, that is). It should be noted that the ones that *have* implemented it can also be queried directly for their help output, like so: </p>
<div class="fragment"><pre class="fragment">
@core help
</pre></div><h3><a class="anchor" id="echo">
The echo service</a></h3>
<p>As I'm sure you've already guessed, the echo service just prints the inbound data right back at you. While that's not exactly nobel prize winning material, it's actually pretty nifty to figure out how fast Nagios can parse its inbound data, which in turn shows how fast it can handle its inbound checkresults, which puts an upper cap on how many checks Nagios can handle at any given time (although short bursts that exceed that limit are ok and will be handled just fine).</p>
<p>It can be addressed as such: </p>
<div class="fragment"><pre class="fragment">
@echo foo bar baz said the bunny\0
</pre></div><h3><a class="anchor" id="nerd">
Nagios Event Radio Dispatcher</a></h3>
<p>The nerd radio is subscribed in fuller detail at </p>
<dl class="see"><dt><b>See also:</b></dt><dd>nerd, but its worth knowing that it's a core part of Nagios 4 and that it will always be available.</dd></dl>
<h3><a class="anchor" id="wproc">
Worker process manager</a></h3>
<p>The worker process manager lets you register workers that can help out with running checks, send notifications, run eventhandlers or whatever.</p>
<p>In order to register a worker that only handles checks supposed to be run by the plugins check_foo and check_bar (irrespective of where in the paths they are), you'd do something like this: </p>
<div class="fragment"><pre class="fragment">
@wproc register name=foobar;plugin=check_foo;plugin=check_bar\0
</pre></div> </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 9 Sep 2017 for Nagios by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
